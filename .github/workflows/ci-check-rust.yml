# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

# -------------------------------------------------------------
#
# CI Check Rust Workflow
#
# This workflow runs checks for Rust code using cargo commands.
# Checks include:
# - static analysis using `cargo check`
# - code formatting using `cargo fmt`
# - linting using `cargo clippy`
# - sorted dependencies check using `cargo sort`
# - documentation tests using `cargo test --doc`
# - documentation generation using `cargo doc`
# - unused dependencies check using `cargo machete`
#
# This workflow can be triggered manually or by other workflows.
#
name: ci-check-rust

on:
  workflow_dispatch:
  workflow_call:

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  check-rust-version-sync:
    name: check Rust version sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Check Rust versions are synchronized
        run: |
          # rust-toolchain.toml -> 1.89(.0) -> 1.89
          TOOLCHAIN_VERSION=$(sed -En 's/^[[:space:]]*channel[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/p' rust-toolchain.toml)
          to_minor() { echo "$1" | sed -E 's/^([0-9]+)\.([0-9]+).*/\1.\2/'; }
          TOOLCHAIN_MINOR=$(to_minor "$TOOLCHAIN_VERSION")

          # Extract X[.Y[.Z]] from Dockerfiles (ignores suffixes like -slim-bookworm), then -> X.Y
          BDD_VERSION=$(sed -En 's/^FROM[[:space:]]+rust:([0-9.]+).*/\1/p' bdd/rust/Dockerfile | head -1)
          BENCH_VERSION=$(sed -En 's/^FROM[[:space:]]+rust:([0-9.]+).*/\1/p' core/bench/dashboard/server/Dockerfile | head -1)
          BDD_MINOR=$(to_minor "$BDD_VERSION")
          BENCH_MINOR=$(to_minor "$BENCH_VERSION")

          # Fail if mismatched
          if [ "$TOOLCHAIN_MINOR" != "$BDD_MINOR" ]; then
            echo "ERROR: bdd/rust/Dockerfile uses $BDD_VERSION (-> $BDD_MINOR) but rust-toolchain.toml specifies $TOOLCHAIN_VERSION (-> $TOOLCHAIN_MINOR)" >&2
            exit 1
          fi

          if [ "$TOOLCHAIN_MINOR" != "$BENCH_MINOR" ]; then
            echo "ERROR: core/bench/dashboard/server/Dockerfile uses $BENCH_VERSION (-> $BENCH_MINOR) but rust-toolchain.toml specifies $TOOLCHAIN_VERSION (-> $TOOLCHAIN_MINOR)" >&2
            exit 1
          fi

          echo "âœ“ All Rust versions are synchronized at $TOOLCHAIN_VERSION"

  check:
    name: cargo check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Run cargo check
        run: |
          cargo check

  fmt:
    name: cargo fmt
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Run cargo fmt
        run: |
          cargo fmt --all -- --check

  clippy:
    name: cargo clippy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Run cargo clippy
        run: |
          cargo clippy --all-targets --all-features -- -D warnings

  sort:
    name: cargo sort
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Install cargo-sort
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-sort
      - name: Run cargo sort
        run: |
          cargo sort --check --workspace

  doctest:
    name: cargo test docs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Run cargo test (doc)
        run: |
          cargo test --doc
      - name: Run cargo doc
        run: |
          cargo doc --no-deps --all-features --quiet

  unused_dependencies:
    name: cargo machete
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install toolchain
        run: |
          echo "Using Rust toolchain from rust-toolchain.toml: $(rustup show)"
      - name: Install cargo-machete
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-machete
      - name: Run cargo machete
        run: |
          cargo machete --with-metadata
